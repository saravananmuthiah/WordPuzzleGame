<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="WordPuzzleGame.MainPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:vm="clr-namespace:WordPuzzleGame.ViewModels"
    Title="Word Puzzle"
    BackgroundColor="{AppThemeBinding Light={StaticResource Background}, Dark={StaticResource OffBlack}}">

    <ContentPage.BindingContext>
        <vm:WordPuzzleViewModel />
    </ContentPage.BindingContext>

    <Grid>
        <!-- Soft background image for the puzzle -->
        <Image Source="puzzle_bg.png"
               Aspect="AspectFill"
               Opacity="0.13"
               VerticalOptions="FillAndExpand"
               HorizontalOptions="FillAndExpand"
               ZIndex="1" />

        <ScrollView ZIndex="2">
            <VerticalStackLayout
                Padding="30,0"
                Spacing="25"
                VerticalOptions="Center">
                <!-- Topic label -->
                <Label
                    Text="{Binding SelectedTopic, Converter={StaticResource UriDecodeConverter}, StringFormat='Topic: {0}'}"
                    Style="{StaticResource Headline}"
                    HorizontalOptions="Center"
                    Margin="0,10,0,0" />

                <!--  Shuffled letters as draggable tiles  -->
                <HorizontalStackLayout
                    x:Name="TilesPanel"
                    Margin="0,10,0,10"
                    HorizontalOptions="Center"
                    Spacing="40"
                    HeightRequest="80">
                    <CollectionView
                        ItemsLayout="HorizontalList"
                        ItemsSource="{Binding ShuffledWordTiles}"
                        SelectionMode="None"
                        HeightRequest="66">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Border
                                    Margin="0,0,10,0"
                                    Padding="10,0,10,10"
                                    BackgroundColor="{AppThemeBinding Light={StaticResource PrimaryLight}, Dark={StaticResource Gray950}}"
                                    Stroke="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryLight}}"
                                    HeightRequest="66"
                                    VerticalOptions="End"
                                    WidthRequest="56">
                                    <Border.StrokeThickness>1</Border.StrokeThickness>
                                    <Label
                                        FontSize="36"
                                        HorizontalOptions="Center"
                                        Text="{Binding .}"
                                        VerticalOptions="End"
                                        TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryLight}}" />
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding BindingContext.TileTapCommand, Source={x:Reference Name=TilesPanel}}" CommandParameter="{Binding .}" />
                                    </Border.GestureRecognizers>
                                </Border>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </HorizontalStackLayout>

                <!--  Drop area for answer  -->
                <HorizontalStackLayout
                    x:Name="DropPanel"
                    Margin="0,10,0,10"
                    HorizontalOptions="Center"
                    Spacing="20"
                    HeightRequest="80">
                    <CollectionView
                        ItemsLayout="HorizontalList"
                        ItemsSource="{Binding UserTiles}"
                        SelectionMode="None"
                        HeightRequest="66">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Border
                                    Margin="0,0,10,0"
                                    Padding="10,0,10,10"
                                    BackgroundColor="{AppThemeBinding Light={StaticResource Secondary}, Dark={StaticResource Gray900}}"
                                    Stroke="{AppThemeBinding Light={StaticResource Tertiary}, Dark={StaticResource Gray500}}"
                                    HeightRequest="66"
                                    VerticalOptions="End"
                                    WidthRequest="56">
                                    <Border.StrokeThickness>1</Border.StrokeThickness>
                                    <Label
                                        FontSize="36"
                                        HorizontalOptions="Center"
                                        Text="{Binding .}"
                                        VerticalOptions="End"
                                        TextColor="{AppThemeBinding Light={StaticResource OnSecondary}, Dark={StaticResource OnSecondary}}" />
                                </Border>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </HorizontalStackLayout>

                <HorizontalStackLayout HorizontalOptions="Center" Spacing="10" HeightRequest="64">
                    <Label
                        FontSize="16"
                        HorizontalOptions="Start"
                        Text="{Binding Hint}"
                        TextColor="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource Gray200}}"
                        FontAttributes="Italic"
                        LineBreakMode="WordWrap"
                        MaxLines="4"
                        WidthRequest="260"
                        VerticalOptions="Center" />
                    <ImageButton
                        Source="refresh.svg"
                        HeightRequest="28"
                        WidthRequest="28"
                        BackgroundColor="Transparent"
                        Command="{Binding RefreshHintCommand}"
                        IsVisible="{Binding Hint, Converter={StaticResource StringToOpacityConverter}}"
                        IsEnabled="{Binding IsHintAvailable}"
                        VerticalOptions="Center"
                        Margin="10,0,0,0" />
                </HorizontalStackLayout>

                <Button
                    Text="Back to Topic Selection"
                    Command="{Binding GoToTopicSelectionCommand}"
                    HorizontalOptions="Center"
                    Margin="0,10,0,0"
                    HeightRequest="40"
                    WidthRequest="220"
                    FontSize="14"
                    BackgroundColor="{AppThemeBinding Light={StaticResource PrimaryLight}, Dark={StaticResource Gray950}}"
                    TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryLight}}"
                    CornerRadius="20"
                    />

                <!--  Feedback message  -->
                <Label
                    Margin="0,20,0,0"
                    FontSize="20"
                    HorizontalOptions="Center"
                    Opacity="{Binding Message, Converter={StaticResource StringToOpacityConverter}}"
                    Text="{Binding Message}"
                    TextColor="{Binding IsSuccess, Converter={StaticResource BoolToColorConverter}, ConverterParameter='Primary,Error'}"
                    HeightRequest="36" />
            </VerticalStackLayout>
        </ScrollView>
    </Grid>

</ContentPage>
